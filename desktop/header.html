<!-- Custom sidebar widget -->

<script type="text/discourse-plugin" version="0.8">
  const ajax = require('discourse/lib/ajax').ajax;

  // script wont run unless user is logged in
  if (api.getCurrentUser() === null) return false;

  let currentUser = Discourse.User.currentProp('username');

  api.registerConnectorClass('discovery-below', 'sidebar', {
    setupComponent(args, component) {
      ajax("/u/" + currentUser + "/summary.json").then (function(result){

        stinkinBadges = [];

        userLikesReceived = result.user_summary.likes_received;
        userLikesGiven = result.user_summary.likes_given;
        userPostCount = result.user_summary.post_count;
        userTopicCount = result.user_summary.topic_count;

        result.badges.forEach(function(badges){
          stinkinBadges.push(badges);
        });

        component.set('userLikesReceived', userLikesReceived);
        component.set('userLikesGiven', userLikesGiven);
        component.set('userPostCount', userPostCount);
        component.set('userTopicCount', userTopicCount);
        component.set('stinkinBadges', stinkinBadges);
        component.set('userName', api.getCurrentUser().name);
        component.set('user', api.getCurrentUser().username);

      });

    }

  });
</script>

<!-- Custom sidebar template -->

<script
  type="text/x-handlebars"
  data-template-name="/connectors/discovery-below/sidebar"
>
  <div class="dbook-sidebar">
    {{#if (theme-setting "sidebar_show_intro")}}
    <h2>ðŸ¤— {{i18n (theme-prefix "sidebar.welcome")}} {{#if userName}}{{i18n (theme-prefix "sidebar.back")}} {{userName}} {{/if}} </h2>
    <p>{{i18n (theme-prefix "sidebar.welcome_subhead")}}</p>
    {{/if}}

    {{#if (theme-setting "sidebar_show_likes")}}
    {{#if userLikesGiven}}
    <div class="likes">
      <h3>{{i18n (theme-prefix "sidebar.likes_header")}}</h3>
      <p>{{userLikesReceived}}
        </p>
      <p>{{i18n.user.summary.likes_received}}
        </p>
      
      {{user-stat value=userLikesReceived icon="heart" label="user.summary.likes_received"}}
      {{user-stat value=userLikesGiven icon="heart" label="user.summary.likes_given"}}
      {{user-stat value=userPostCount icon="heart" label="user.summary.post_count"}}
      {{user-stat value=userTopicCount icon="heart" label="user.summary.topic_count"}}
    </div>
    {{/if}}
    {{/if}}

    {{#unless user}}
      <div class="visitor">
        {{replace-emoji (i18n "signup_cta.value_prop")}}
        {{d-button action=(route-action "showCreateAccount") class="btn-primary sign-up-button" label="sign_up"}}
      </div>
    {{/unless}}

  </div>

  {{#if user}}
  <a class="sidebar-link" href="/my/summary">{{i18n (theme-prefix "sidebar.full_profile")}}</a>
  {{/if}}
</script>
